<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manual RI WAR Upgrade Using Updated Appliance</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem;
      line-height: 1.4;
    }
    h1, h2, h3 {
      margin-top: 1.5rem;
    }
    code {
      font-family: Menlo, Consolas, monospace;
      font-size: 0.9rem;
      background: #f4f4f4;
      padding: 0.15rem 0.3rem;
      border-radius: 3px;
    }
    pre {
      background: #f4f4f4;
      padding: 0.75rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .section {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 1rem;
      margin-top: 1rem;
    }
    .form-section {
      border: 1px solid #1e88e5;
      background: #f0f7ff;
      border-radius: 6px;
      padding: 1rem;
      margin-top: 2rem;
    }
    label {
      display: block;
      margin-top: 0.4rem;
      font-size: 0.9rem;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.35rem;
      margin-top: 0.15rem;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 0.9rem;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.4rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    textarea {
      width: 100%;
      height: 260px;
      margin-top: 0.75rem;
      font-family: Menlo, Consolas, monospace;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
    }
  </style>
</head>
<body>

<h1>Manual RI WAR Upgrade Using an Updated Appliance</h1>

<p>
This guide is for RI techs who need to manually replace <code>rapididentity.war</code> on on prem appliances using an appliance that already took the update.
</p>

<div class="section">
  <h2>High level flow</h2>
  <ol>
    <li>Snapshot all appliances.</li>
    <li>Stop RI on all appliances in the cluster (DB appliance stopped last).</li>
    <li>On an updated appliance, copy <code>/var/opt/idauto/rapididentity.war</code> into the SFTP jail.</li>
    <li>From your workstation, SFTP that WAR down.</li>
    <li>For each appliance that needs the upgrade, back up the existing WAR, upload the new one, and set owner and permissions.</li>
    <li>Start RI again (DB appliance started first).</li>
    <li>Verify logs and cluster status in the portal.</li>
  </ol>
</div>

<div class="section">
  <h2>Step 1: Snapshot all appliances</h2>
  <p>
    Take a snapshot of every appliance in the cluster in your hypervisor. If you skip this and something goes wrong, you will not have a quick rollback.
  </p>
</div>

<div class="section">
  <h2>Step 2: Stop RI on all appliances (DB last)</h2>

  <p>
    Stop RI on all appliances in the cluster. Application nodes can be stopped in any order. The database appliance must be stopped last, and will be started first later. All appliances depend on the DB being online.
  </p>

  <h3>2.1 Stop from the config menu</h3>
  <ol>
    <li>SSH as <code>config</code> to each appliance in the cluster.</li>
    <li>In the RI CLI menu go to option 1 RapidIdentity.</li>
    <li>Select option 1 to stop the RI service.</li>
  </ol>

  <p class="small">
    If you are already in tech mode instead of the config menu, you can stop RI with:
  </p>
  <pre>service rapididentity stop</pre>
</div>

<div class="section">
  <h2>Step 3: Prepare WAR on an updated appliance</h2>

  <p>
    Pick one appliance that successfully took the update. This will be your source.
  </p>

  <h3>3.1 Set SFTP password on the source appliance</h3>
  <ol>
    <li>SSH as <code>config</code> to the updated appliance.</li>
    <li>In the menu go to Security.</li>
    <li>Select Change SFTP password and set a password for user <code>sftp</code>.</li>
  </ol>

  <h3>3.2 Copy the WAR into the SFTP jail (tech mode)</h3>
  <ol>
    <li>From the config menu enter tech mode.</li>
    <li>Run:</li>
  </ol>
  <pre>cp /var/opt/idauto/rapididentity.war /var/sftp/files/rapididentity.war</pre>

  <p class="small">
    When you log in as <code>sftp</code> you will land in a jailed directory. You can <code>cd files</code> inside that jail. Standard SFTP commands like <code>get</code>, <code>put</code>, <code>ls</code>, and <code>lls</code> work as expected.
  </p>
</div>

<div class="section">
  <h2>Step 4: Download WAR to your workstation</h2>

  <h3>4.1 SFTP to the updated appliance</h3>
  <p>From your workstation terminal:</p>
  <pre>sftp sftp@UPDATED_APPLIANCE_IP</pre>

  <p>In the SFTP session:</p>
  <pre>
cd files
ls
get rapididentity.war
bye
  </pre>

  <p>
    You now have <code>rapididentity.war</code> locally on your workstation.
  </p>
</div>

<div class="section">
  <h2>Step 5: Replace WAR on each appliance that needs the upgrade</h2>

  <p>
    Repeat this entire step for every appliance that needs the updated WAR.
  </p>

  <h3>5.1 Set SFTP password on the target appliance</h3>
  <ol>
    <li>SSH as <code>config</code> to the target appliance.</li>
    <li>In the menu go to Security.</li>
    <li>Select Change SFTP password and set a password for <code>sftp</code>.</li>
  </ol>

  <h3>5.2 Back up the existing WAR (tech mode)</h3>
  <ol>
    <li>From the config menu enter tech mode.</li>
    <li>Run:</li>
  </ol>
  <pre>
cd /var/opt/idauto
mv rapididentity.war.last rapididentity.war.old
mv rapididentity.war rapididentity.war.last
  </pre>

  <h3>5.3 Upload the new WAR</h3>

  <p>From your workstation terminal (where the new <code>rapididentity.war</code> is stored):</p>
  <pre>sftp sftp@TARGET_APPLIANCE_IP</pre>

  <p>In the SFTP session:</p>
  <pre>
cd files
put rapididentity.war
ls
bye
  </pre>

  <p>Back in the tech mode shell on the target appliance:</p>
  <pre>
cd /var/opt/idauto
mv /var/sftp/files/rapididentity.war /var/opt/idauto/rapididentity.war
  </pre>

  <h3>5.4 Set owner and permissions</h3>

  <p>Owner and permissions should be:</p>
  <pre>-r-xr-x--- 1 idauto idauto ... rapididentity.war</pre>

  <p>To enforce that on the target appliance:</p>
  <pre>
chown idauto:idauto /var/opt/idauto/rapididentity.war
chmod 550 /var/opt/idauto/rapididentity.war
ls -l /var/opt/idauto/rapididentity.war
  </pre>

  <p>
    Verify that the owner is <code>idauto</code>, group is <code>idauto</code>, and the permissions are <code>-r-xr-x---</code>.
  </p>
</div>

<div class="section">
  <h2>Step 6: Start RI on all appliances (DB first)</h2>

  <p>
    Start RI again on all appliances. The database appliance must be started first, then the remaining appliances in any order.
  </p>

  <h3>6.1 Start from the config menu</h3>
  <ol>
    <li>SSH as <code>config</code> to each appliance.</li>
    <li>In the RI CLI menu go to option 1 RapidIdentity.</li>
    <li>Select option 1 to start the RI service.</li>
  </ol>

  <p class="small">
    If you are in tech mode instead of the menu, you can start RI with:
  </p>
  <pre>service rapididentity start</pre>
</div>

<div class="section">
  <h2>Step 7: Verify logs and cluster status</h2>

  <h3>7.1 Check logs from the menu</h3>
  <p>
    On each appliance, from the config menu, go to the logs menu and open the RI application log. The menu uses <code>less</code>, so you can search and scroll.
  </p>
  <p>
    Confirm that each appliance starts cleanly, connects to the database, and joins the cluster. Cluster join messages are typically near the license messages.
  </p>

  <h3>7.2 Check in the portal</h3>
  <ol>
    <li>Log in to the RI portal.</li>
    <li>Go to Configuration and review the appliance or cluster view.</li>
    <li>Confirm that all appliances show in the cluster and report the correct version that matches the already updated on prem appliances.</li>
  </ol>
</div>

<div class="form-section">
  <h2>Optional: Generate SSH and SFTP commands</h2>
  <p class="small">
    Enter IPs for up to three updated appliances (sources) and three appliances that need the upgrade (targets). Click Generate to get basic SSH and SFTP commands you can copy.
  </p>

  <h3>Updated appliances (source)</h3>
  <label for="src1">Source appliance 1 IP</label>
  <input type="text" id="src1" placeholder="e.g. 192.168.254.10">

  <label for="src2">Source appliance 2 IP</label>
  <input type="text" id="src2" placeholder="optional">

  <label for="src3">Source appliance 3 IP</label>
  <input type="text" id="src3" placeholder="optional">

  <h3>Appliances needing upgrade (target)</h3>
  <label for="dst1">Target appliance 1 IP</label>
  <input type="text" id="dst1" placeholder="e.g. 192.168.254.20">

  <label for="dst2">Target appliance 2 IP</label>
  <input type="text" id="dst2" placeholder="optional">

  <label for="dst3">Target appliance 3 IP</label>
  <input type="text" id="dst3" placeholder="optional">

  <button type="button" onclick="generateCommands()">Generate commands</button>
  <button type="button" onclick="copyCommands()">Copy all</button>

  <textarea id="commandOutput" placeholder="Generated commands will appear here..."></textarea>

  <p class="small">
    These use SSH user <code>config</code> and SFTP user <code>sftp</code>. Adjust if your environment uses different usernames.
  </p>
</div>

<script>
  function generateCommands() {
    var srcIps = [
      document.getElementById("src1").value.trim(),
      document.getElementById("src2").value.trim(),
      document.getElementById("src3").value.trim()
    ];
    var dstIps = [
      document.getElementById("dst1").value.trim(),
      document.getElementById("dst2").value.trim(),
      document.getElementById("dst3").value.trim()
    ];

    var lines = [];
    lines.push("=== Updated appliances (source) ===");
    for (var i = 0; i < srcIps.length; i++) {
      if (!srcIps[i]) continue;
      lines.push("");
      lines.push("Source appliance " + (i + 1) + " (" + srcIps[i] + ")");
      lines.push("ssh config@" + srcIps[i]);
      lines.push("sftp sftp@" + srcIps[i]);
    }

    lines.push("");
    lines.push("=== Appliances needing upgrade (target) ===");
    for (var j = 0; j < dstIps.length; j++) {
      if (!dstIps[j]) continue;
      lines.push("");
      lines.push("Target appliance " + (j + 1) + " (" + dstIps[j] + ")");
      lines.push("ssh config@" + dstIps[j]);
      lines.push("sftp sftp@" + dstIps[j]);
    }

    document.getElementById("commandOutput").value = lines.join("\n");
  }

  function copyCommands() {
    var textArea = document.getElementById("commandOutput");
    textArea.select();
    textArea.setSelectionRange(0, 99999);
    try {
      document.execCommand("copy");
    } catch (e) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(textArea.value);
      }
    }
  }
</script>

</body>
</html>
